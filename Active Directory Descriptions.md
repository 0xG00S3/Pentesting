## ACTIVE DIRECTORY

### Kerberos Authentication

Kerberos authentication starts when a user submits their credentials to the KDC (Key Distribution Center) for authentication. 

The KDC is comprised of two portions: 
1) The Authentication Service - Responsible for authenticating users and issuing TGTs' (Ticket Granting Tickets).
2) The Ticket Granting Service - Responsible for authenticating TGTs' and issuing Service Tickets. 

The users credentials are submitted to the Authentication Service which then validates the credentials and returns a TGT to the user. 

When the user wants to authenticate to a service in the network they must request a Service Ticket from the Ticket Granting Service using the previously issued TGT from the Authentication Service. Say the user wants to access an MSSQL Server within the environment, they would attempt toauthenticate to this service and the following process unfolds:
1) Their TGT is passed to the TGS which validates the legitimacy of the TGT ensuring it is valid within the 8 hour default Window of when it was issued by the AS, the TGS also validates the clock skew.
2) The TGS validates if the user is authorized to access the requested resource.
3) If all checks out, the TGS issues the user a Service Ticket which they can use to authenticate to the requested resource.
4) The user presents the newly acquired service ticket to the MSSQL server which uses the NTLM hash of the service account or account it is operating as to decrypt it, performs the same time checks and authenticates the user.

(This is a simplified version of everything that actually happens, my goal here is to summarize the concepts / steps so it is easier to understand.)

It is important to note that when performing offensive operations, Service Tickets are quieter than TGT's. Once a service ticket has been issued by the TGS it is signed using the NTLM hash of the Service Account the service is running as on the network. Everything is contained within the Service Ticket that is needed for authentication to the target service. This minimizes the traffic to the KDC which the Security Operations Analysts are typically watching quite closely. 

**Kerberos relies on time synchronization:**
1) Kerberos relies heavily on time synchronization across all machines on the network, typically the NTP (Network Time Protocol) is used for this. If the clock skew is greater than 5 minutes between machines kerberos may reject otherwise valid tickets. We run into this sometimes in offensive security operations where we need to sync our attacking machines with the target environment to get kerberos authentication working smoothly. 

